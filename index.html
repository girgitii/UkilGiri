<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UkilGiri</title>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Hind Siliguri', 'Poppins', 'Söhne', 'Helvetica Neue', Arial, sans-serif;
}

:root {
    --primary-gradient: linear-gradient(135deg, #10a37f, #0d8c6d);
    --secondary-gradient: linear-gradient(135deg, #5436DA, #4a2ec4);
    --dark-bg: #1a1b26;
    --sidebar-bg: #16171d;
    --message-user-bg: #2d2e3a;
    --message-ai-bg: #343541;
    --accent-color: #10a37f;
    --text-color: #f0f0f5;
    --border-radius: 12px;
    --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 10px 15px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 20px 25px rgba(0, 0, 0, 0.15);
    --transition: all 0.3s ease;
}

body {
    background-color: var(--dark-bg);
    color: var(--text-color);
    height: 100vh;
    overflow: hidden;
}

.app-container {
    display: flex;
    height: 100vh;
    position: relative;
}

/* Modern Sidebar */
.sidebar {
    width: 300px;
    background-color: var(--sidebar-bg);
    display: flex;
    flex-direction: column;
    padding: 20px;
    box-shadow: var(--shadow-md);
    z-index: 10;
    border-right: 1px solid rgba(255, 255, 255, 0.05);
    transition: var(--transition);
}

.app-title {
    padding: 20px 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
    text-align: center;
    position: relative;
}

.app-title::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, rgba(16, 163, 127, 0.1), transparent 70%);
    z-index: -1;
    opacity: 0.8;
    animation: pulse 3s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 0.5;
        transform: scale(0.95);
    }
    50% {
        opacity: 0.8;
        transform: scale(1.05);
    }
}

.app-title h1 {
    font-size: 32px;
    font-weight: 800;
    position: relative;
    display: inline-block;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    letter-spacing: 0.5px;
}

.app-title h1 span {
    display: inline-block;
}

.app-title h1 .ukil {
    background: linear-gradient(135deg, #10a37f, #5436DA);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: colorShift 8s infinite alternate;
}

.app-title h1 .giri {
    background: linear-gradient(135deg, #ff3e9d, #0e8aff);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: colorShift 8s infinite alternate-reverse;
}

.app-title h1::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #10a37f, #5436DA, #ff3e9d, #0e8aff);
    border-radius: 4px;
    animation: gradientMove 4s linear infinite;
    box-shadow: 0 2px 8px rgba(84, 54, 218, 0.5);
}

@keyframes colorShift {
    0% {
        filter: hue-rotate(0deg);
    }
    100% {
        filter: hue-rotate(60deg);
    }
}

@keyframes gradientMove {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

.new-chat button {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: var(--border-radius);
    background: var(--primary-gradient);
    color: white;
    text-align: center;
    cursor: pointer;
    margin-bottom: 25px;
    font-size: 16px;
    font-weight: 600;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.new-chat button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.new-chat button:active {
    transform: translateY(0);
}

.history {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
}

.history::-webkit-scrollbar {
    width: 5px;
}

.history::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

.history::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
}

.history-item {
    padding: 15px;
    cursor: pointer;
    border-radius: var(--border-radius);
    margin-bottom: 12px;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    background-color: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: var(--transition);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.history-item:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.history-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
}

.delete-chat-btn {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.5);
    font-size: 18px;
    cursor: pointer;
    padding: 0 5px;
    transition: var(--transition);
}

.delete-chat-btn:hover {
    color: #ff6b6b;
}

/* Modern Main Content */
.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative;
    overflow: hidden;
}

.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    scroll-behavior: smooth;
}

.chat-container::-webkit-scrollbar {
    width: 8px;
}

.chat-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
}

.chat-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 10px;
}

.welcome-message {
    max-width: 800px;
    margin: 0 auto;
    text-align: center;
    padding: 40px 20px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    border: 1px solid rgba(255, 255, 255, 0.05);
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.welcome-message h2 {
    margin-bottom: 20px;
    font-size: 28px;
    background: linear-gradient(135deg, #10a37f, #5436DA);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.welcome-message ul {
    text-align: left;
    display: inline-block;
    margin-top: 20px;
}

.welcome-message li {
    margin-bottom: 15px;
    list-style-type: none;
    position: relative;
    padding-left: 25px;
    transition: var(--transition);
}

.welcome-message li:before {
    content: '•';
    position: absolute;
    left: 0;
    color: var(--accent-color);
    font-size: 20px;
}

.welcome-message li:hover {
    transform: translateX(5px);
}

.message-row {
    padding: 25px;
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    animation: messageAppear 0.3s ease-out;
}

@keyframes messageAppear {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-row {
    background-color: var(--message-user-bg);
    border-left: 4px solid #5436DA;
}

.ai-row {
    background-color: var(--message-ai-bg);
    border-left: 4px solid #10a37f;
}

.message-row:hover {
    box-shadow: var(--shadow-md);
}

.avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    box-shadow: var(--shadow-sm);
    color: white;
}

.user-avatar {
    background: var(--secondary-gradient);
}

.ai-avatar {
    background: var(--primary-gradient);
}

.avatar svg {
    width: 24px;
    height: 24px;
    stroke: white;
}

.message-content {
    flex: 1;
    line-height: 1.7;
    font-size: 16px;
    max-width: 800px;
    position: relative;
    z-index: 1;
    letter-spacing: 0.01em;
    font-weight: 400;
}

.message-content strong {
    font-weight: 600;
    color: #fff;
}

.input-container {
    padding: 25px;
    position: relative;
    background-color: var(--dark-bg);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.input-box {
    max-width: 900px;
    margin: 0 auto;
    position: relative;
    border-radius: var(--border-radius);
    background-color: var(--message-user-bg);
    box-shadow: var(--shadow-md);
    transition: var(--transition);
    border: 2px solid transparent;
    background-image: linear-gradient(var(--message-user-bg), var(--message-user-bg)), 
                     linear-gradient(45deg, #10a37f, #5436DA, #ff3e9d, #0e8aff, #10a37f, #5436DA);
    background-origin: border-box;
    background-clip: padding-box, border-box;
    animation: rotateBorder 3s linear infinite;
}

@keyframes rotateBorder {
    0% {
        background-image: linear-gradient(var(--message-user-bg), var(--message-user-bg)),
                         linear-gradient(0deg, #10a37f, #5436DA, #ff3e9d, #0e8aff, #10a37f);
    }
    25% {
        background-image: linear-gradient(var(--message-user-bg), var(--message-user-bg)),
                         linear-gradient(90deg, #10a37f, #5436DA, #ff3e9d, #0e8aff, #10a37f);
    }
    50% {
        background-image: linear-gradient(var(--message-user-bg), var(--message-user-bg)),
                         linear-gradient(180deg, #10a37f, #5436DA, #ff3e9d, #0e8aff, #10a37f);
    }
    75% {
        background-image: linear-gradient(var(--message-user-bg), var(--message-user-bg)),
                         linear-gradient(270deg, #10a37f, #5436DA, #ff3e9d, #0e8aff, #10a37f);
    }
    100% {
        background-image: linear-gradient(var(--message-user-bg), var(--message-user-bg)),
                         linear-gradient(360deg, #10a37f, #5436DA, #ff3e9d, #0e8aff, #10a37f);
    }
}

.input-box:focus-within {
    box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.5);
}

.input-box:focus-within::before {
    animation-duration: 1.5s;
}

textarea {
    width: 100%;
    padding: 18px 60px 18px 18px;
    background-color: transparent;
    border: none;
    color: white;
    font-size: 16px;
    resize: none;
    outline: none;
    max-height: 200px;
    border-radius: var(--border-radius);
}

textarea::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

#sendBtn {
    position: absolute;
    right: 12px;
    bottom: 12px;
    background: var(--primary-gradient);
    border: none;
    color: white;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    box-shadow: 0 2px 10px rgba(16, 163, 127, 0.3);
    transition: all 0.3s ease;
    overflow: hidden;
}

#sendBtn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(16, 163, 127, 0.5);
}

#sendBtn:active {
    transform: scale(0.95);
}

#sendBtn svg {
    width: 18px;
    height: 18px;
    filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
}

#sendBtn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
    border-radius: 50%;
}

.disclaimer {
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
    font-size: 13px;
    margin-top: 20px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    padding: 10px;
    border-radius: var(--border-radius);
    background-color: rgba(255, 255, 255, 0.03);
}

/* Code block styling */
pre {
    background-color: #282c34;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 15px 0;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

code {
    font-family: 'Fira Code', 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 14px;
}

/* Loading animation */
.loading-dots {
    display: inline-flex;
    align-items: center;
}

.loading-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.7);
    margin: 0 4px;
    animation: dot-pulse 1.5s infinite ease-in-out;
}

.loading-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.loading-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes dot-pulse {
    0%, 100% { transform: scale(0.8); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 1; }
}

/* Add styling for formatted content */
.message-content ul, .message-content ol {
    margin: 15px 0;
    padding-left: 30px;
}

.message-content li {
    margin-bottom: 8px;
}

.message-content h1, .message-content h2, .message-content h3 {
    margin: 15px 0 10px 0;
    padding: 10px 0;
    color: var(--text-color);
    font-weight: 600;
    background: none;
    border: none;
    box-shadow: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    display: block;
}

.message-content p {
    margin-bottom: 10px;
    line-height: 1.6;
}

.bullet-point {
    position: relative;
    padding-left: 5px;
    margin-bottom: 12px;
}

.numbered-point {
    position: relative;
    padding-left: 5px;
    margin-bottom: 12px;
}

.numbered-point .number {
    font-weight: 600;
    color: var(--accent-color);
    margin-right: 5px;
}

/* 3D Loading Animation */
.loading-animation {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 60px;
    perspective: 800px;
}

.loading-sphere {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10a37f, #5436DA);
    animation: rotate3d 2s infinite ease-in-out;
    position: relative;
    transform-style: preserve-3d;
    box-shadow: 0 0 20px rgba(16, 163, 127, 0.4);
}

.loading-sphere::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(84, 54, 218, 0.7), rgba(16, 163, 127, 0.7));
    filter: blur(5px);
    animation: pulse 2s infinite alternate;
}

@keyframes rotate3d {
    0% {
        transform: rotateX(0deg) rotateY(0deg);
    }
    25% {
        transform: rotateX(180deg) rotateY(0deg);
    }
    50% {
        transform: rotateX(180deg) rotateY(180deg);
    }
    75% {
        transform: rotateX(0deg) rotateY(180deg);
    }
    100% {
        transform: rotateX(0deg) rotateY(0deg);
    }
}

@keyframes pulse {
    0% {
        opacity: 0.5;
        transform: scale(0.8);
    }
    100% {
        opacity: 1;
        transform: scale(1.1);
    }
}

/* Responsive design */
@media (max-width: 768px) {
    .app-container {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        height: auto;
        max-height: 200px;
    }

    .chat-container {
        padding: 15px 10px;
    }

    .message-row {
        padding: 15px 10px;
        margin-left: 0;
        margin-right: 0;
    }

    .input-container {
        padding: 15px 10px;
    }
    
    .avatar {
        margin-right: 10px;
        width: 35px;
        height: 35px;
        min-width: 35px;
    }
    
    .message-content {
        width: 100%;
    }
    
    .welcome-message {
        padding: 20px 10px;
        margin: 0;
    }
}

/* Mobile Navigation Bar */
.mobile-nav {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background-color: var(--sidebar-bg);
    padding: 10px 15px;
    z-index: 100;
    box-shadow: var(--shadow-md);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.mobile-nav-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.mobile-menu-btn {
    background: none;
    border: none;
    color: var(--text-color);
    font-size: 24px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: var(--transition);
}

.mobile-menu-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.mobile-logo h1 {
    font-size: 24px;
    font-weight: 800;
    margin: 0;
}

.mobile-logo h1 .ukil {
    background: linear-gradient(135deg, #10a37f, #5436DA);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.mobile-logo h1 .giri {
    background: linear-gradient(135deg, #ff3e9d, #0e8aff);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.mobile-new-chat {
    background: var(--primary-gradient);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
}

.mobile-new-chat:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
}

/* Mobile Sidebar */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 90;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.sidebar-overlay.active {
    opacity: 1;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .mobile-nav {
        display: block;
    }
    
    .app-container {
        flex-direction: column;
        padding-top: 60px; /* Make room for the fixed nav */
    }
    
    .sidebar {
        position: fixed;
        top: 60px;
        left: -300px;
        bottom: 0;
        width: 280px;
        height: auto;
        min-height: calc(100% - 60px);
        max-height: none;
        z-index: 95;
        transition: left 0.3s ease;
        border-right: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: var(--shadow-lg);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    .sidebar.active {
        left: 0;
    }
    
    .history {
        flex: 1;
        max-height: none;
        overflow-y: auto;
    }
    
    .sidebar-overlay.active {
        display: block;
    }
    
    .app-title {
        display: none;
    }
    
    .new-chat {
        margin-top: 0;
    }
    
    .main-content {
        width: 100%;
    }
}

/* Animated banner */
.animated-banner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 30px;
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 1000;
    overflow: hidden;
    display: flex;
    align-items: center;
}

.banner-text {
    white-space: nowrap;
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
    font-weight: 500;
    animation: moveText 20s linear infinite;
    padding: 0 20px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

@keyframes moveText {
    0% {
        transform: translateX(100%);
    }
    100% {
        transform: translateX(-100%);
    }
}

/* Adjust other elements to account for the banner */
.mobile-nav {
    top: 30px;
}

.app-container {
    padding-top: 30px;
}

@media (max-width: 768px) {
    .app-container {
        padding-top: 90px; /* 30px for banner + 60px for mobile nav */
    }
    
    .sidebar {
        top: 90px;
        min-height: calc(100% - 90px);
    }
}
    </style>
</head>
<body>
    <div class="animated-banner">
        <div class="banner-text">এই ওয়েবসাইটটি বানিয়েছেন- সালাউদ্দিন মজুমদার। ©All rights reserved</div>
    </div>
    
    <div class="mobile-nav">
        <div class="mobile-nav-inner">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="mobile-logo">
                <h1><span class="ukil">Ukil</span><span class="giri">Giri</span></h1>
            </div>
            <button class="mobile-new-chat" id="mobileNewChatBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>
    </div>
    
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="app-container">
        <aside class="sidebar">
            <div class="app-title">
                <h1><span class="ukil">Ukil</span><span class="giri">Giri</span></h1>
            </div>
            <div class="new-chat">
                <button id="newChatBtn">+ নতুন আলোচনা</button>
            </div>
            <div class="history" id="chatHistory">
                <!-- Chat history will appear here -->
            </div>
        </aside>
        <main class="main-content">
            <div class="chat-container" id="chatContainer">
                <!-- Chat messages will appear here -->
            </div>
            <div class="input-container">
                <div class="input-box">
                    <textarea id="userInput" placeholder="আপনার আইনি প্রশ্ন জিজ্ঞাসা করুন..." rows="1"></textarea>
                    <button id="sendBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="none" class="h-4 w-4 m-1 md:m-0" stroke-width="2">
                            <path d="M.5 1.163A1 1 0 0 1 1.97.28l12.868 6.837a1 1 0 0 1 0 1.766L1.969 15.72A1 1 0 0 1 .5 14.836V10.33a1 1 0 0 1 .816-.983L8.5 8 1.316 6.653A1 1 0 0 1 .5 5.67V1.163Z" fill="currentColor"></path>
                        </svg>
                    </button>
                </div>
                <div class="disclaimer">
                    UkilGiri সাধারণ আইনি তথ্য প্রদান করে। এটি একজন আইনজীবীর পরামর্শের বিকল্প নয়। জরুরি পরিস্থিতিতে, অনুগ্রহ করে একজন যোগ্য আইনজীবীর সাথে যোগাযোগ করুন।
                </div>
            </div>
        </main>
    </div>
    <script>
const API_KEY = "AIzaSyDXxWIwHQoYbs3Fl7Q4iq2r7hSVLhyMlBs";
const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

const chatContainer = document.getElementById("chatContainer");
const chatHistory = document.getElementById("chatHistory");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const newChatBtn = document.getElementById("newChatBtn");

let conversations = [];
let currentConversationId = Date.now();

// Auto-resize textarea
userInput.addEventListener("input", function() {
    this.style.height = "auto";
    this.style.height = (this.scrollHeight) + "px";
    if (this.scrollHeight > 200) {
        this.style.overflowY = "auto";
    } else {
        this.style.overflowY = "hidden";
    }
});

// Add event listeners
sendBtn.addEventListener("click", handleUserInput);
userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleUserInput();
    }
});

newChatBtn.addEventListener("click", () => {
    currentConversationId = Date.now();
    chatContainer.innerHTML = "";
    addWelcomeMessage();
    saveConversation("নতুন আলোচনা", []);
    updateChatHistory();
});

// Display a welcome message
function addWelcomeMessage() {
    const welcomeDiv = document.createElement("div");
    welcomeDiv.classList.add("welcome-message");
    welcomeDiv.innerHTML = `
        <h2>UkilGiri-তে স্বাগতম</h2>
        <p>আমি আপনাকে সাধারণ আইনি তথ্য এবং প্রাথমিক দিকনির্দেশনা প্রদান করতে পারি। উদাহরণস্বরূপ, আপনি জিজ্ঞাসা করতে পারেন:</p>
        <ul>
            <li>"আমার ল্যান্ডলর্ড আমার জামানত ফেরত দিচ্ছে না, আমি কী করতে পারি?"</li>
            <li>"বাংলাদেশে ডিভোর্সের আইনি প্রক্রিয়া কী?"</li>
            <li>"ট্রাফিক আইন লঙ্ঘনের জন্য জরিমানা কত?"</li>
            <li>"চাকরি থেকে অন্যায়ভাবে বরখাস্ত হলে আমার অধিকার কী?"</li>
        </ul>
        <p><strong>দয়া করে মনে রাখবেন:</strong> আমি সাধারণ তথ্য প্রদান করি এবং এটি আইনি পরামর্শের বিকল্প নয়। জটিল আইনি সমস্যার জন্য, অনুগ্রহ করে একজন যোগ্য আইনজীবীর সাথে পরামর্শ করুন।</p>
    `;
    chatContainer.innerHTML = "";
    chatContainer.appendChild(welcomeDiv);
}

addWelcomeMessage();
loadConversations();

async function handleUserInput() {
    const message = userInput.value.trim();
    if (!message) return;

    // Display user message
    addMessage(message, "user");

    // Save to current conversation
    saveMessageToCurrentConversation(message, "user");

    // Reset textarea height
    userInput.value = "";
    userInput.style.height = "auto";

    // Show loading indicator
    const loadingId = showLoading();

    try {
        // Enhanced prompt with constitutional focus and detailed guidance
        const legalPrompt = `You are UkilGiri, a legal assistant AI specializing in Bangladesh law.

User question: "${message}"

Please provide a detailed and easy-to-understand answer in Bengali language with the following priorities:
1. HIGHEST PRIORITY: Reference relevant sections from the Constitution of Bangladesh when applicable - ALWAYS include article numbers and direct quotes when referencing the Constitution
2. Include EXTENSIVE citations to specific laws, acts, and legal precedents - mention section numbers, act names, and years
3. For each legal point, provide the exact reference (e.g., "According to Section 54 of the Code of Criminal Procedure, 1898...")
4. Explain legal concepts in simple terms that a non-lawyer can understand
5. Provide practical guidance on what steps the person might take
6. Use bullet points and clear organization for complex information
7. Include both the legal perspective and practical real-world considerations

Your response MUST be rich with specific legal references while remaining accessible. When citing laws:
- For constitutional provisions: "Article X of the Constitution of Bangladesh states..."
- For statutory laws: "Section Y of the [Law Name] Act, [Year] provides that..."
- For case law: "In the case of [Case Name], the court held that..."

Make your response comprehensive but accessible, avoiding complex legal jargon when possible. When legal terms are necessary, explain them clearly.`;

        // Get response
        let legalResponse = await fetchAIResponse(legalPrompt);

        // Remove loading indicator
        removeLoading(loadingId);

        // Display AI response
        addMessage(legalResponse, "ai");

        // Save to current conversation
        saveMessageToCurrentConversation(legalResponse, "ai");

    } catch (error) {
        removeLoading(loadingId);
        // Error message in Bangla
        const errorMessage = "দুঃখিত, আপনার প্রশ্নের উত্তর দিতে একটি সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।";
        addMessage(errorMessage, "ai");
        saveMessageToCurrentConversation(errorMessage, "ai");
        console.error("Error:", error);
    }
}

function addMessage(text, sender) {
    const messageRow = document.createElement("div");
    messageRow.classList.add("message-row", `${sender}-row`);

    const avatar = document.createElement("div");
    avatar.classList.add("avatar", `${sender}-avatar`);

    // Add relevant icons instead of text
    if (sender === "user") {
        avatar.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
    } else {
        // Classic scales of justice icon for AI
        avatar.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 3L4 9v2l8-6 8 6V9z"></path>
                <path d="M4 11v1a8 8 0 0 0 16 0v-1"></path>
                <path d="M8 15a4 4 0 0 0 8 0"></path>
                <line x1="12" y1="3" x2="12" y2="21"></line>
                <circle cx="6" cy="11" r="2"></circle>
                <circle cx="18" cy="11" r="2"></circle>
            </svg>
        `;
    }

    const messageContent = document.createElement("div");
    messageContent.classList.add("message-content");

    // Format the text with proper paragraphs
    messageContent.innerHTML = formatMessageText(text);

    messageRow.appendChild(avatar);
    messageRow.appendChild(messageContent);

    chatContainer.appendChild(messageRow);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function formatMessageText(text) {
    // First handle bullet points at the beginning of lines
    let lines = text.split('\n');
    let formattedLines = lines.map(line => {
        // Replace bullet points (•, *, -) at the beginning of lines with icons
        if (line.trim().match(/^[•\*\-]\s+/)) {
            return line.replace(/^([•\*\-])\s+(.*)$/, '<p class="bullet-point">⚖️ $2</p>');
        }
        return line;
    });
    
    text = formattedLines.join('\n');
    
    // Now handle other formatting
    // Replace markdown-style bold with HTML bold
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // Replace single asterisks with HTML emphasis (only for emphasis, not bullet points)
    text = text.replace(/\b\*(.*?)\*\b/g, '<em>$1</em>');
    
    // Replace numbered lists with styled numbers
    text = text.replace(/^(\d+)\.\s+(.*?)$/gm, '<p class="numbered-point"><span class="number">$1.</span> $2</p>');

    // Convert text to paragraphs (for lines that aren't already converted)
    const paragraphs = text.split('\n').filter(p => p.trim() !== '');
    const formattedParagraphs = paragraphs.map(p => {
        if (!p.startsWith('<p')) {
            return `<p>${p}</p>`;
        }
        return p;
    }).join('');

    // Return the formatted paragraphs
    return formattedParagraphs;
}

function showLoading() {
    const messageRow = document.createElement("div");
    messageRow.classList.add("message-row", "ai-row");
    messageRow.id = "loading-" + Date.now();

    const avatar = document.createElement("div");
    avatar.classList.add("avatar", "ai-avatar");
    avatar.textContent = "AI";

    const messageContent = document.createElement("div");
    messageContent.classList.add("message-content");
    messageContent.innerHTML = `
        <div class="loading-animation">
            <div class="loading-sphere"></div>
        </div>
    `;

    messageRow.appendChild(avatar);
    messageRow.appendChild(messageContent);

    chatContainer.appendChild(messageRow);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return messageRow.id;
}

function removeLoading(id) {
    const loadingDiv = document.getElementById(id);
    if (loadingDiv) loadingDiv.remove();
}

async function fetchAIResponse(prompt) {
    const requestBody = {
        contents: [{
            parts: [{
                text: prompt
            }]
        }]
    };

    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
        throw new Error(`API request failed with status ${response.status}`);
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

// Conversation history management
function saveMessageToCurrentConversation(message, sender) {
    // Find current conversation
    let conversation = conversations.find(c => c.id === currentConversationId);

    if (!conversation) {
        // Create new conversation if it doesn't exist
        conversation = {
            id: currentConversationId,
            title: message.substring(0, 30) + (message.length > 30 ? "..." : ""),
            messages: []
        };
        conversations.push(conversation);
    }

    // Add message to conversation
    conversation.messages.push({
        sender: sender,
        message: message,
        timestamp: new Date().toISOString()
    });

    // Update title if this is the first user message
    if (sender === "user" && conversation.messages.filter(m => m.sender === "user").length === 1) {
        conversation.title = message.substring(0, 30) + (message.length > 30 ? "..." : "");
    }

    // Save to localStorage
    localStorage.setItem("legalAiConversations", JSON.stringify(conversations));

    // Update sidebar
    updateChatHistory();
}

function saveConversation(title, messages) {
    const conversation = {
        id: currentConversationId,
        title: title,
        messages: messages
    };

    // Check if conversation already exists
    const existingIndex = conversations.findIndex(c => c.id === currentConversationId);
    if (existingIndex >= 0) {
        conversations[existingIndex] = conversation;
    } else {
        conversations.push(conversation);
    }

    // Save to localStorage
    localStorage.setItem("legalAiConversations", JSON.stringify(conversations));
}

function loadConversations() {
    const saved = localStorage.getItem("legalAiConversations");
    if (saved) {
        conversations = JSON.parse(saved);
        updateChatHistory();
    }
}

function updateChatHistory() {
    chatHistory.innerHTML = "";

    conversations.forEach(conversation => {
        const historyItem = document.createElement("div");
        historyItem.classList.add("history-item");
        historyItem.dataset.id = conversation.id;
        historyItem.innerHTML = `
            <div class="history-title">${conversation.title}</div>
            <button class="delete-chat-btn" data-id="${conversation.id}">×</button>
        `;

        historyItem.addEventListener("click", (e) => {
            if (!e.target.classList.contains("delete-chat-btn")) {
                loadConversation(conversation.id);
            }
        });

        chatHistory.appendChild(historyItem);
    });

    // Add event listeners for delete buttons
    document.querySelectorAll(".delete-chat-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
            e.stopPropagation();
            const id = parseInt(btn.dataset.id);
            deleteConversation(id);
        });
    });
}

function loadConversation(id) {
    const conversation = conversations.find(c => c.id === id);
    if (!conversation) return;

    currentConversationId = id;
    chatContainer.innerHTML = "";

    conversation.messages.forEach(msg => {
        addMessage(msg.message, msg.sender);
    });

    // If no messages, show welcome
    if (conversation.messages.length === 0) {
        addWelcomeMessage();
    }
}

function deleteConversation(id) {
    conversations = conversations.filter(c => c.id !== id);
    localStorage.setItem("legalAiConversations", JSON.stringify(conversations));
    updateChatHistory();

    // If current conversation was deleted, start a new one
    if (currentConversationId === id) {
        currentConversationId = Date.now();
        chatContainer.innerHTML = "";
        addWelcomeMessage();
    }
}

// Function to check if text contains too much English
function containsTooMuchEnglish(text) {
    // Count English words (simple approximation)
    const englishWordCount = (text.match(/\b[A-Za-z]+\b/g) || []).length;

    // Count total words
    const totalWordCount = text.split(/\s+/).length;

    // If more than 5% of words are English, consider it too much (stricter threshold)
    return (englishWordCount / totalWordCount) > 0.05;
}

// Function to convert Latin numerals to Bengali numerals
function convertToBengaliNumeral(number) {
    const bengaliNumerals = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
    return number.toString().split('').map(digit => bengaliNumerals[parseInt(digit)]).join('');
}

// Add this to your JavaScript section
const mobileMenuBtn = document.getElementById("mobileMenuBtn");
const mobileNewChatBtn = document.getElementById("mobileNewChatBtn");
const sidebar = document.querySelector(".sidebar");
const sidebarOverlay = document.getElementById("sidebarOverlay");

// Toggle sidebar
mobileMenuBtn.addEventListener("click", () => {
    sidebar.classList.toggle("active");
    sidebarOverlay.classList.toggle("active");
});

// Close sidebar when clicking overlay
sidebarOverlay.addEventListener("click", () => {
    sidebar.classList.remove("active");
    sidebarOverlay.classList.remove("active");
});

// Mobile new chat button
mobileNewChatBtn.addEventListener("click", () => {
    currentConversationId = Date.now();
    chatContainer.innerHTML = "";
    addWelcomeMessage();
    saveConversation("নতুন আলোচনা", []);
    updateChatHistory();
    
    // Close sidebar if open
    sidebar.classList.remove("active");
    sidebarOverlay.classList.remove("active");
});
    </script>
</body>
</html>

















